# Versions
x-runtime-version: &runtime-version '23.08'
x-gl-version: &gl-version '1.4'
x-gl-versions: &gl-versions 23.08;1.4
x-jagex-launcher-linux-sha: &jagex-launcher-linux-sha 'd3653ddc0f2c119f66220c27d4043ca6766007d2'
# Flatpak manifest
app-id: com.jagex.Launcher
runtime: org.freedesktop.Platform
runtime-version: *runtime-version
sdk: org.freedesktop.Sdk
command: /app/bin/launch.sh
finish-args:
  - --allow=multiarch
  - --allow=devel
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --persist=.runelite
  - --persist=jagexcache
  - --env=WINEPREFIX=/var/data/wine
  - --env=WINEARCH=win64
  - --env=WINEDLLOVERRIDES=dxgi=b # Fix launch on Steam Deck by using builtin dxgi
  - --env=GST_PLUGIN_SYSTEM_PATH=/app/lib32/gstreamer-1.0:/app/lib/gstreamer-1.0:/usr/lib/i386-linux-gnu/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0
  - --env=mesa_glthread=true
  - --env=MESA_LOADER_DRIVER_OVERRIDE=zink
sdk-extensions:
  - org.freedesktop.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.openjdk11
add-extensions:
  org.freedesktop.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: *runtime-version
  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: *gl-version
    versions: *gl-versions
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver
modules:
  - name: wine
    buildsystem: simple
    build-commands:
      - mkdir -p /app/wine
      - cp -r * /app/wine
    sources:
      - type: archive
        url: https://github.com/GloriousEggroll/wine-ge-custom/releases/download/GE-Proton8-24/wine-lutris-GE-Proton8-24-x86_64.tar.xz
        archive-type: tar-xz
        sha256: 9813f345b26e1f9f978b42674fc875fbe7cdbac1384e099b490f5211946f54d1
  - name: jagex-launcher-linux
    buildsystem: simple
    build-options:
      build-args:
        # Allow pip to install packages. Since these packages
        # never get installed into the final flatpak I'm
        # not very concerned with the reproducibility of this.
        - --share=network
    build-commands:
      - mkdir -p /app/Jagex\ Launcher
      - |
        export OLDPWD=$PWD \
        && . venv/bin/activate \
        && cd /app/Jagex\ Launcher \
        && python ${OLDPWD}/resources/installer.py \
        && deactivate \
        && cd ${OLDPWD} \
        && rm -rf venv \
        && unset OLDPWD
    sources:
      - type: git
        url: https://github.com/USA-RedDragon/jagex-launcher-linux.git
        commit: *jagex-launcher-linux-sha
      - type: shell
        commands:
          - python -m venv venv
          - . venv/bin/activate && pip install -r resources/requirements.txt && deactivate
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk11/install.sh
  - name: runelite
    buildsystem: simple
    build-commands:
      - mkdir -p /app/RuneLite
      - cp -r -v RuneLite.jar /app/RuneLite
      - echo -e "#!/bin/bash\n/app/jre/bin/java -jar /app/RuneLite/RuneLite.jar" > /app/RuneLite/RuneLite.exe
      - chmod +x /app/RuneLite/RuneLite.exe
    sources:
      - type: file
        url: https://github.com/runelite/launcher/releases/download/2.6.10/RuneLite.jar
        dest-filename: RuneLite.jar
        sha256: b73561c714ad58984669f0b909731d4cc4c6bacdbf07d227006243d1b566138b
  - name: hdos
    buildsystem: simple
    build-commands:
      - mkdir -p /app/HDOS
      - cp -r -v HDOS.jar /app/HDOS
      - echo -e "#!/bin/bash\nenv _JAVA_OPTIONS=-Duser.home=\${XDG_DATA_HOME}/hdos /app/jre/bin/java -jar /app/HDOS/HDOS.jar" > /app/HDOS/HDOS.exe
      - chmod +x /app/HDOS/HDOS.exe
    sources:
      - type: file
        url: https://cdn.hdos.dev/launcher/v8/hdos-launcher.jar
        dest-filename: HDOS.jar
        sha256: d3475d791fa8bfa4e3ae7fa9b1c5e86a8e02d1e93f88ff4776582af78ea92fc0
  - name: bundle-setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib/i386-linux-gnu/GL
      - mkdir -p /app/lib/debug/lib/i386-linux-gnu
      - install -Dm755 launch.sh /app/bin/launch.sh
      - install -Dm644 ld.so.conf /app/etc/ld.so.conf
      - install -Dm644 16x16.png /app/share/icons/hicolor/16x16/apps/com.jagex.Launcher.png
      - install -Dm644 32x32.png /app/share/icons/hicolor/32x32/apps/com.jagex.Launcher.png
      - install -Dm644 48x48.png /app/share/icons/hicolor/48x48/apps/com.jagex.Launcher.png
      - install -Dm644 64x64.png /app/share/icons/hicolor/64x64/apps/com.jagex.Launcher.png
      - install -Dm644 128x128.png /app/share/icons/hicolor/128x128/apps/com.jagex.Launcher.png
      - install -Dm644 256x256.png /app/share/icons/hicolor/256x256/apps/com.jagex.Launcher.png
      - install -D com.jagex.Launcher.desktop /app/share/applications/com.jagex.Launcher.desktop
      - install -D com.jagex.Launcher.metainfo.xml /app/share/metainfo/com.jagex.Launcher.metainfo.xml
      - |
        rm -rf /app/wine/bin/msidb /app/wine/bin/msiexec /app/wine/bin/notepad \
          /app/wine/bin/regedit /app/wine/bin/regsvr32 /app/wine/bin/wine-preloader \
          /app/wine/bin/wine64-preloader /app/wine/bin/wineconsole /app/wine/bin/winedbg \
          /app/wine/bin/wineconsole /app/wine/bin/winedbg /app/wine/bin/winefile \
          /app/wine/bin/winemine /app/wine/bin/winepath /app/lib/debug \
          /app/wine/share/man /app/wine/share/applications/wine.desktop
    sources:
      - type: inline
        dest-filename: ld.so.conf
        contents: |
          /app/lib32
          /app/lib/i386-linux-gnu
      - type: inline
        dest-filename: launch.sh
        contents: |
          #!/bin/bash

          # Clear any potential jagexcache so we can symlink it to the persisted jagexcache
          rm -rf "${XDG_DATA_HOME}/hdos/jagexcache"
          mkdir -p "${XDG_DATA_HOME}/hdos"
          ln -sf ../../jagexcache ${XDG_DATA_HOME}/hdos/jagexcache

          mkdir -p "${WINEPREFIX}/drive_c/Program Files (x86)/"
          if [ ! -d "${WINEPREFIX}/drive_c/Program Files (x86)/Jagex Launcher" ]; then
            cp -r /app/Jagex\ Launcher "${WINEPREFIX}/drive_c/Program Files (x86)/"
          fi
          /app/wine/bin/wineboot -u

          # Check WINEPREFIX for RuneLite Launcher_is1 key
          if ! grep -q "RuneLite Launcher_is1" "${WINEPREFIX}/drive_c/user.reg"; then
            /app/wine/bin/wine reg.exe add "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\RuneLite Launcher_is1" /v "InstallLocation" /t REG_SZ /d "Z:\\app\\RuneLite" /f
          fi

          # Check WINEPREFIX for HDOS Launcher_is1 key
          if ! grep -q "HDOS Launcher_is1" "${WINEPREFIX}/drive_c/user.reg"; then
            /app/wine/bin/wine reg.exe add "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\HDOS Launcher_is1" /v "InstallLocation" /t REG_SZ /d "Z:\\app\\HDOS" /f
          fi

          exec /app/wine/bin/wine "${WINEPREFIX}/drive_c/Program Files (x86)/Jagex Launcher/JagexLauncher.exe" "$@"
      - type: file
        path: resources/icons/16x16.png
      - type: file
        path: resources/icons/32x32.png
      - type: file
        path: resources/icons/48x48.png
      - type: file
        path: resources/icons/64x64.png
      - type: file
        path: resources/icons/128x128.png
      - type: file
        path: resources/icons/256x256.png
      - type: file
        path: resources/com.jagex.Launcher.desktop
      - type: file
        path: resources/com.jagex.Launcher.metainfo.xml
